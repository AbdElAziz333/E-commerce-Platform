services:
  # TODO: for production use elastic cloud for elasticsearch and kibana
  # TODO: for postgres use AWS RDS or GCP SQL
  # TODO: for redis use AWS MemoryDB or elasticache
  # TODO: for cassandra use datastax astra -- https://docs.datastax.com/en/astra-cli/install.html
  # TODO: for mongodb use mongo atlas
  config-server-svc:
    container_name: config-server
    image: abdelaziz333/config-server:1.0
    build:
      context: ./config-server
    ports:
      - "8203:8203"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      VAULT_TOKEN: ${VAULT_TOKEN}
      VAULT_SVC: ${VAULT_SVC}
      VAULT_PORT: ${VAULT_PORT}
      GIT_CONFIG_REPOSITORY_URI: ${GIT_CONFIG_REPOSITORY_URI}
      GIT_USERNAME: ${GIT_USERNAME}
      GIT_PAT: ${GIT_PAT}
    restart: unless-stopped
    profiles:
      - prod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8203/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  discovery-server-svc:
    container_name: discovery-server
    image: abdelaziz333/discovery-server:1.0
    build:
      context: ./discovery-server
    ports:
      - "${DISCOVERY_SERVER_PORT}:${DISCOVERY_SERVER_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8761/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  auth-service-svc:
    container_name: auth-service
    image: abdelaziz333/auth-service:1.0
    build:
      context: ./auth-service
    ports:
      - "${AUTH_SERVICE_PORT}:${AUTH_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      AUTH_SERVICE_SVC: ${AUTH_SERVICE_SVC}
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT}
      REDIS_SVC: ${AUTH_REDIS_SVC}
      REDIS_PORT: ${AUTH_REDIS_PORT}
    restart: unless-stopped
    depends_on:
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  user-service-svc:
    container_name: user-service
    image: abdelaziz333/user-service:1.0
    build:
      context: ./user-service
    ports:
      - "${USER_SERVICE_PORT}:${USER_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      USER_SERVICE_PORT: ${USER_SERVICE_PORT}
      POSTGRES_SVC: ${USER_POSTGRES_SVC}
      POSTGRES_DB: ${USER_POSTGRES_DB}
      POSTGRES_USER: ${USER_POSTGRES_USER}
      POSTGRES_PORT: ${USER_POSTGRES_PORT}
      POSTGRES_PASSWORD: ${USER_POSTGRES_PASSWORD}
      REDIS_SVC: ${USER_REDIS_SVC}
      REDIS_PORT: ${USER_REDIS_PORT}
      KAFKA_SVC: ${KAFKA_SVC}
      KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
      KAFKA_CONTROLLER_PORT: ${KAFKA_CONTROLLER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8080/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  product-service-svc:
    container_name: product-service
    image: abdelaziz333/product-service:1.0
    build:
      context: ./product-service
    ports:
      - "${PRODUCT_SERVICE_PORT}:${PRODUCT_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      PRODUCT_SERVICE_PORT: ${PRODUCT_SERVICE_PORT}
      MONGO_SVC: ${PRODUCT_MONGO_SVC}
      MONGO_DB: ${PRODUCT_MONGO_DB}
      MONGO_PORT: ${PRODUCT_MONGO_PORT}
      MONGO_USER: ${PRODUCT_MONGO_USER}
      MONGO_PASSWORD: ${PRODUCT_MONGO_PASSWORD}
      ELASTIC_USER: ${ELASTIC_USER}
      ELASTIC_HTTP_PORT: ${ELASTIC_HTTP_PORT}
      ELASTIC_TRANSPORT_PORT: ${ELASTIC_TRANSPORT_PORT}
      KAFKA_SVC: ${KAFKA_SVC}
      KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
      KAFKA_CONTROLLER_PORT: ${KAFKA_CONTROLLER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8081/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  order-service-svc:
    container_name: order-service
    image: abdelaziz333/order-service:1.0
    build:
      context: ./order-service
    ports:
      - "${ORDER_SERVICE_PORT}:${ORDER_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      ORDER_SERVICE_PORT: ${ORDER_SERVICE_PORT}
      POSTGRES_SVC: ${ORDER_POSTGRES_SVC}
      POSTGRES_DB: ${ORDER_POSTGRES_DB}
      POSTGRES_USER: ${ORDER_POSTGRES_USER}
      POSTGRES_PASSWORD: ${ORDER_POSTGRES_PASSWORD}
      POSTGRES_PORT: ${ORDER_POSTGRES_PORT}
      KAFKA_SVC: ${KAFKA_SVC}
      KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
      KAFKA_CONTROLLER_PORT: ${KAFKA_CONTROLLER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8082/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  cart-service-svc:
    container_name: cart-service
    image: abdelaziz333/cart-service:1.0
    build:
      context: ./cart-service
    ports:
      - "${CART_SERVICE_PORT}:${CART_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      CART_SERVICE_PORT: ${CART_SERVICE_PORT}
      POSTGRES_SVC: ${CART_POSTGRES_SVC}
      POSTGRES_DB: ${CART_POSTGRES_DB}
      POSTGRES_USER: ${CART_POSTGRES_USER}
      POSTGRES_PASSWORD: ${CART_POSTGRES_PASSWORD}
      POSTGRES_PORT: ${CART_POSTGRES_PORT}
      REDIS_SVC: ${CART_REDIS_SVC}
      REDIS_PORT: ${CART_REDIS_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8084/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  notification-service-svc:
    container_name: notification-service
    image: abdelaziz333/notification-service:1.0
    build:
      context: ./notification-service
    ports:
      - "${NOTIFICATION_SERVICE_PORT}:${NOTIFICATION_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      NOTIFICATION_SERVICE_PORT: ${NOTIFICATION_SERVICE_PORT}
      CASSANDRA_SVC: ${NOTIFICATION_CASSANDRA_SVC}
      CASSANDRA_KEYSPACE: ${NOTIFICATION_CASSANDRA_KEYSPACE}
      CASSANDRA_PORT: ${NOTIFICATION_CASSANDRA_PORT}
      KAFKA_SVC: ${KAFKA_SVC}
      KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
      KAFKA_CONTROLLER_PORT: ${KAFKA_CONTROLLER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8085/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  payment-service-svc:
    container_name: payment-service
    image: abdelaziz333/payment-service:1.0
    build:
      context: ./payment-service
    ports:
      - "${PAYMENT_SERVICE_PORT}:${PAYMENT_SERVICE_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
      PAYMENT_SERVICE_PORT: ${PAYMENT_SERVICE_PORT}
      POSTGRES_SVC: ${PAYMENT_POSTGRES_SVC}
      POSTGRES_DB: ${PAYMENT_POSTGRES_DB}
      POSTGRES_USER: ${PAYMENT_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PAYMENT_POSTGRES_PASSWORD}
      POSTGRES_PORT: ${PAYMENT_POSTGRES_PORT}
      KAFKA_SVC: ${KAFKA_SVC}
      KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
      KAFKA_CONTROLLER_PORT: ${KAFKA_CONTROLLER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
#      payment-postgres-svc:
#        condition: service_healthy
    profiles:
      - prod
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8086/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  api-gateway-svc:
    container_name: api-gateway
    image: abdelaziz333/api-gateway:1.0
    build:
      context: ./api-gateway
    ports:
      - "${API_GATEWAY_PORT}:${API_GATEWAY_PORT}"
    networks:
      - ecommerce-net
    environment:
      LHOST: ${LHOST}
      CONFIG_SERVER_SVC: ${CONFIG_SERVER_SVC}
      CONFIG_SERVER_PORT: ${CONFIG_SERVER_PORT}
      DISCOVERY_SERVER_SVC: ${DISCOVERY_SERVER_SVC}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT}
    restart: unless-stopped
    depends_on:
      config-server-svc:
        condition: service_healthy
      discovery-server-svc:
        condition: service_healthy
      auth-service-svc:
        condition: service_healthy
      user-service-svc:
        condition: service_healthy
      notification-service-svc:
        condition: service_healthy
      product-service-svc:
        condition: service_healthy
      payment-service-svc:
        condition: service_healthy
      order-service-svc:
        condition: service_healthy
      cart-service-svc:
        condition: service_healthy
    profiles:
      - prod

  auth-redis-svc:
    container_name: auth-redis
    image: redis:alpine
    ports:
      - "6380:6379"
    networks:
      - ecommerce-net
    restart: unless-stopped
    profiles:
      - dev
      - prod

  user-postgres-svc:
    container_name: user-postgres
    image: postgres:alpine
    ports:
      - "5432:5432"
    networks:
      - ecommerce-net
    volumes:
      - user_postgres_data:/var/lib/postgresql/data
    secrets:
      - user_postgres_password
    environment:
      POSTGRES_DB: ${USER_POSTGRES_DB}
      POSTGRES_USER: ${USER_POSTGRES_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/user_postgres_password
    restart: unless-stopped
    profiles:
      - dev
      - prod

  user-redis-svc:
    container_name: user-redis
    image: redis:alpine
    ports:
      - "6379:6379"
    networks:
      - ecommerce-net
    restart: unless-stopped
    profiles:
      - dev
      - prod

  product-mongo-svc:
    container_name: product-mongo
    image: mongo:latest
    ports:
      - "27017:27017"
    networks:
      - ecommerce-net
    volumes:
      - product_mongo_data:/data/db
    secrets:
      - product_mongo_password
    environment:
      MONGO_INITDB_DATABASE: ${PRODUCT_MONGO_DB}
      MONGO_INITDB_ROOT_USERNAME: ${PRODUCT_MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/product_mongo_password
    restart: unless-stopped
    profiles:
      - dev
      - prod

  order-postgres-svc:
    container_name: order-postgres
    image: postgres:alpine
    ports:
      - "5434:5432"
    networks:
      - ecommerce-net
    volumes:
      - order_postgres_data:/var/lib/postgresql/data
    secrets:
      - order_postgres_password
    environment:
      POSTGRES_DB: ${ORDER_POSTGRES_DB}
      POSTGRES_USER: ${ORDER_POSTGRES_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/order_postgres_password
    restart: unless-stopped
    profiles:
      - dev
      - prod

  cart-postgres-svc:
    container_name: cart-postgres
    image: postgres:alpine
    ports:
      - "5433:5432"
    networks:
      - ecommerce-net
    volumes:
      - cart_postgres_data:/var/lib/postgresql/data
    secrets:
      - cart_postgres_password
    environment:
      POSTGRES_DB: ${CART_POSTGRES_DB}
      POSTGRES_USER: ${CART_POSTGRES_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/cart_postgres_password
    restart: unless-stopped
    profiles:
      - dev
      - prod

  cart-redis-svc:
    container_name: cart-redis
    image: redis:alpine
    ports:
      - "6381:6379"
    networks:
      - ecommerce-net
    restart: unless-stopped
    profiles:
      - dev
      - prod

  payment-postgres-svc:
    container_name: payment-postgres
    image: postgres:alpine
    ports:
      - "5435:5432"
    networks:
      - ecommerce-net
    volumes:
      - payment_postgres_data:/var/lib/postgresql/data
    secrets:
      - payment_postgres_password
    environment:
      POSTGRES_DB: ${PAYMENT_POSTGRES_DB}
      POSTGRES_USER: ${PAYMENT_POSTGRES_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/payment_postgres_password
    restart: unless-stopped
    profiles:
      - dev
      - prod

  notification-cassandra-svc:
    container_name: notification-cassandra
    image: cassandra:4.1
    ports:
      - "9042:9042"
    networks:
      - ecommerce-net
    volumes:
      - notification_cassandra_data:/var/lib/cassandra
      - ./cassandra/init/cassandra-init.sh:/cassandra-init.sh
    entrypoint: ["/bin/bash", "/cassandra-init.sh"]
    environment:
      CASSANDRA_CLUSTER_NAME: ${NOTIFICATION_CASSANDRA_CLUSTER_NAME}
      CASSANDRA_DC: dc1
      CASSANDRA_RACK: rack1
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
      CASSANDRA_KEYSPACE: ${NOTIFICATION_CASSANDRA_KEYSPACE}
      MAX_HEAP_SIZE: "512M"
      HEAP_NEWSIZE: "256M"
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-kafka-svc:
    container_name: infra-kafka
    image: bitnami/kafka:latest
    ports:
      - "9092:9092"
      - "9093:9093"
    networks:
      - ecommerce-net
    volumes:
      - infra_kafka_data:/bitnami/kafka
    environment:
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://infra-kafka-svc:9092
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@infra-kafka-svc:9093

      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      ALLOW_PLAINTEXT_LISTENER: yes
    restart: unless-stopped
    profiles:
      - prod
      - dev

  infra-vault-svc:
    container_name: infra-vault
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    networks:
      - ecommerce-net
    volumes:
      - ./infra/vault/config/vault.hcl:/vault/config/vault.hcl:ro
      - ./infra/vault/data:/vault/data
      - ./infra/vault/logs:/vault/logs
    command: vault server -config=/vault/config/vault.hcl
    cap_add:
      - IPC_LOCK
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-elastic-svc:
    container_name: infra-elastic
    image: elasticsearch:9.1.5
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - ecommerce-net
    volumes:
      - infra_elastic_data:/usr/share/elasticsearch/data
    environment:
      discovery.type: single-node
      xpack.security.enabled: false
      action.auto_create_index: true
      ES_JAVA_OPTS: "-Xms1g -Xmx1g"
      cluster.routing.allocation.disk.threshold_enabled: false
      number_of_replicas: 0
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-kibana-svc:
    container_name: infra-kibana
    image: kibana:9.1.5
    ports:
      - "5601:5601"
    networks:
      - ecommerce-net
    environment:
      ELASTICSEARCH_HOSTS: http://infra-elastic-svc:9200
      xpack.security.enabled: false
    depends_on:
      - infra-elastic-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-otel-svc:
    container_name: infra-otel
    image: otel/opentelemetry-collector:latest
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP http receiver
    networks:
      - ecommerce-net
    volumes:
      - ./infra/observability/otel-collector/config.yml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - infra-prometheus-svc
      - infra-loki-svc
      - infra-tempo-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-prometheus-svc:
    container_name: infra-prometheus
    image: prom/prometheus:main
    volumes:
      - ./infra/observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - ecommerce-net
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-loki-svc:
    container_name: infra-loki
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    networks:
      - ecommerce-net
    volumes:
      - ./infra/observability/loki/config.yml:/etc/loki/config.yml
    command: -config.file=./etc/loki/config.yml
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-tempo-svc:
    container_name: infra-tempo
    image: grafana/tempo:latest
    ports:
      - "3200:3200"
    networks:
      - ecommerce-net
    volumes:
      - ./infra/observability/tempo/tempo.yml:/etc/tempo/tempo.yml
    command: -config.file=./etc/tempo/tempo.yml
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-grafana-svc:
    container_name: infra-grafana
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    networks:
      - ecommerce-net
    environment:
      - GF_SECURITY_ADMIN=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_PATHS_PROVISIONING=/infra/observability/grafana/provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./infra/observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - infra-prometheus-svc
      - infra-loki-svc
      - infra-tempo-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  # Exporters

  infra-user-postgres-exporter-svc:
    image: prometheuscommunity/postgres-exporter:master
    container_name: infra-user-postgres-exporter
    ports:
      - "9187:9187"
    networks:
      ecommerce-net:
    environment:
      DATA_SOURCE_NAME: "postgresql://${USER_POSTGRES_USER}:${USER_POSTGRES_PASSWORD}@user-postgres-svc:5432/${USER_POSTGRES_DB}?sslmode=disable"
    depends_on:
      - user-postgres-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-order-postgres-exporter-svc:
    image: prometheuscommunity/postgres-exporter:master
    container_name: infra-order-postgres-exporter
    ports:
      - "9188:9187"
    networks:
      ecommerce-net:
    environment:
      DATA_SOURCE_NAME: "postgresql://${ORDER_POSTGRES_USER}:${ORDER_POSTGRES_PASSWORD}@order-postgres-svc:5432/${ORDER_POSTGRES_DB}?sslmode=disable"
    depends_on:
      - order-postgres-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-cart-postgres-exporter-svc:
    image: prometheuscommunity/postgres-exporter:master
    container_name: infra-cart-postgres-exporter
    ports:
      - "9189:9187"
    networks:
      ecommerce-net:
    environment:
      DATA_SOURCE_NAME: "postgresql://${CART_POSTGRES_USER}:${CART_POSTGRES_PASSWORD}@cart-postgres-svc:5432/${CART_POSTGRES_DB}?sslmode=disable"
    depends_on:
      - cart-postgres-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-payment-postgres-exporter-svc:
    image: prometheuscommunity/postgres-exporter:master
    container_name: infra-payment-postgres-exporter
    ports:
      - "9190:9187"
    networks:
      ecommerce-net:
    environment:
      DATA_SOURCE_NAME: "postgresql://${PAYMENT_POSTGRES_USER}:${PAYMENT_POSTGRES_PASSWORD}@payment-postgres-svc:5432/${PAYMENT_POSTGRES_DB}?sslmode=disable"
    depends_on:
      - payment-postgres-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-user-redis-exporter-svc:
    container_name: infra-user-redis-exporter
    image: oliver006/redis_exporter:alpine
    ports:
      - "9121:9121"
    networks:
      ecommerce-net:
    environment:
      REDIS_ADDR: "user-redis-svc:6379"
    depends_on:
      - user-redis-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-auth-redis-exporter-svc:
    container_name: infra-auth-redis-exporter
    image: oliver006/redis_exporter:alpine
    ports:
      - "9122:9121"
    networks:
      ecommerce-net:
    environment:
      REDIS_ADDR: "auth-redis-svc:6379"
    depends_on:
      - auth-redis-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod

  infra-cart-redis-exporter-svc:
    container_name: infra-cart-redis-exporter
    image: oliver006/redis_exporter:alpine
    ports:
      - "9123:9121"
    networks:
      ecommerce-net:
    environment:
      REDIS_ADDR: "cart-redis-svc:6379"
    depends_on:
      - cart-redis-svc
    restart: unless-stopped
    profiles:
      - dev
      - prod
      
  infra-product-mongo-exporter-svc:
    container_name: infra-product-mongo-exporter
    image: percona/mongodb_exporter:0.47.2
    ports:
      - "9216:9216"
    networks:
      ecommerce-net:
    restart: unless-stopped
    command:
      - "--mongo.uri=mongodb://${PRODUCT_MONGO_USER}:${PRODUCT_MONGO_PASSWORD}@product-mongo-svc:27017"

volumes:
  user_postgres_data:
  product_mongo_data:
  order_postgres_data:
  notification_cassandra_data:
  cart_postgres_data:
  payment_postgres_data:
  infra_kafka_data:
  infra_elastic_data:
  otel_data:
  grafana_data:

secrets:
  user_postgres_password:
    file: secrets/user_postgres_password.txt
#  infra_elastic_password:
#    file: secrets/infra_elastic_password.txt
  product_mongo_password:
    file: secrets/product_mongo_password.txt
  order_postgres_password:
    file: secrets/order_postgres_password.txt
  cart_postgres_password:
    file: secrets/cart_postgres_password.txt
  payment_postgres_password:
    file: secrets/payment_postgres_password.txt

networks:
  ecommerce-net:
    external: true